package com.thingtrack.konekti.view.web.form.internal;

import java.text.DecimalFormat;
import java.text.DecimalFormatSymbols;
import java.text.ParseException;
import java.util.ArrayList;
import java.util.List;
import java.util.Set;

import org.vaadin.addon.customfield.CustomField;
import org.vaadin.addons.locationtextfield.GeocodedLocation;
import org.vaadin.addons.locationtextfield.GeocodingException;

import com.vaadin.annotations.AutoGenerated;
import com.vaadin.data.Property.ValueChangeNotifier;
import com.vaadin.ui.Alignment;
import com.vaadin.ui.Button;
import com.vaadin.ui.Button.ClickEvent;
import com.vaadin.ui.Field;
import com.vaadin.ui.HorizontalLayout;
import com.vaadin.ui.Label;
import com.vaadin.ui.TextField;

public class CoordinatesInputComponent extends CustomField implements ValueChangeNotifier {

	/*- VaadinEditorProperties={"grid":"RegularGrid,20","showGrid":true,"snapToGrid":true,"snapToObject":true,"movingGuides":false,"snappingDistance":10} */

	@AutoGenerated
	private HorizontalLayout mainLayout;
	@AutoGenerated
	private Button latLonFetchButton;
	@AutoGenerated
	private HorizontalLayout horizontalLayout_3;
	@AutoGenerated
	private Label label_3;
	@AutoGenerated
	private TextField latTextField;
	@AutoGenerated
	private Label label_2;
	@AutoGenerated
	private TextField lonTextField;
	@AutoGenerated
	private Label label_1;
	private DecimalFormat decimalFormat;

	private ExtendedURLConnectionGeocoder<GeocodedLocation> locationProvider;

	private List<ValueChangeListener> listeners;

	private GeocodedLocation geocodedLocation;

	
	/**
	 * The constructor should first build the main layout, set the
	 * composition root and then do any custom initialization.
	 *
	 * The constructor will not be automatically regenerated by the
	 * visual editor.
	 */
	public CoordinatesInputComponent() {
		buildMainLayout();
		setCompositionRoot(mainLayout);

		// TODO add user code here
		DecimalFormatSymbols decimalFormatSymbols = new DecimalFormatSymbols();
		decimalFormatSymbols.setDecimalSeparator('.');
		decimalFormat = new DecimalFormat("###.######", decimalFormatSymbols);
		decimalFormat.setParseIntegerOnly(false);
		
		listeners = new ArrayList<ValueChangeListener>();
		
		latTextField.setNullRepresentation("");
		latTextField.setInputPrompt("latitud");
		lonTextField.setNullRepresentation("");
		lonTextField.setInputPrompt("longitud");
		
		latLonFetchButton.addListener(new Button.ClickListener() {
			
			@Override
			public void buttonClick(ClickEvent event) {

				if(locationProvider == null)
					throw new RuntimeException("The location provider is null");
				
				try {
					
					double latitude = castCoordinateToDouble((String)latTextField.getValue());
					double longitude = castCoordinateToDouble((String)lonTextField.getValue());
					
					List<GeocodedLocation> geocodedLocations = new ArrayList<GeocodedLocation>((Set<GeocodedLocation>) locationProvider.reverseGeocode(longitude, latitude));
					
					if(geocodedLocations.size() > 0)
						CoordinatesInputComponent.this.geocodedLocation = geocodedLocations.get(0);
					
					// Notify listeners a new geological location
					for(ValueChangeListener listener : listeners)
						listener.valueChange(new Field.ValueChangeEvent(CoordinatesInputComponent.this));	
				}
				catch (GeocodingException e) {
					throw new RuntimeException("No valid <latitude, longitude>");
				}
				
			}
		});
	}

	@Override
	public Class<?> getType() {
		return GeocodedLocation.class;
	}
	
	@Override
	public Object getValue() {
		return geocodedLocation;
	}
	
	@Override
	public void setValue(Object newValue) throws ReadOnlyException,
			ConversionException {
		
		if (newValue != null && !(newValue instanceof GeocodedLocation))
			throw new ConversionException("There is an "
					+ GeocodedLocation.class.getSimpleName());

		geocodedLocation = (GeocodedLocation) newValue;
		
		//Nullable location
		if(geocodedLocation == null)
		{
			latTextField.setValue(null);
			lonTextField.setValue(null);
		}
		
		// It is not geocoded
		else if(geocodedLocation.getGeocodedAddress() == null){
			try {
				List<GeocodedLocation> geocodedLocations = new ArrayList<GeocodedLocation>((Set<GeocodedLocation>) locationProvider.reverseGeocode(geocodedLocation.getLat(), geocodedLocation.getLon()));
				
				if(geocodedLocations.size() > 0 )
					this.geocodedLocation = geocodedLocations.get(0);
				
			} catch (GeocodingException e) {
				throw new RuntimeException(e);
			}
		}
		
		// Set the text values
		latTextField.setValue(castCoordinateToString(geocodedLocation.getLat()));
		lonTextField.setValue(castCoordinateToString(geocodedLocation.getLon()));
		
		// Notify listeners a new geological location
		for(ValueChangeListener listener : listeners)
			listener.valueChange(new Field.ValueChangeEvent(CoordinatesInputComponent.this));

	}
	
	@Override
	public void addListener(ValueChangeListener listener) {
		listeners.add(listener);
	}
	
	@Override
	public void removeListener(ValueChangeListener listener) {
		listeners.remove(listener);
	}
	
	private String castCoordinateToString(Double coordinate){
		return decimalFormat.format(coordinate);
	}
	
	private Double castCoordinateToDouble(String coordinate){

		try {
			Number coordenateNumber = decimalFormat.parse(coordinate);
			return coordenateNumber.doubleValue();
		} catch (ParseException e) {
			throw new RuntimeException(e);
		}
	}
	
	public void setLocationProvider(MapQuestNominatimGeocoder locationProvider) {
		this.locationProvider = locationProvider;
	}
	
	public void setLocationProvider(ExtendedGoogleGeocoder locationProvider) {
		this.locationProvider = locationProvider;
	}

	@AutoGenerated
	private HorizontalLayout buildMainLayout() {
		// common part: create layout
		mainLayout = new HorizontalLayout();
		mainLayout.setImmediate(false);
		mainLayout.setWidth("100%");
		mainLayout.setHeight("-1px");
		mainLayout.setMargin(false);
		mainLayout.setSpacing(true);
		
		// top-level component properties
		setWidth("100.0%");
		setHeight("-1px");
		
		// label_1
		label_1 = new Label();
		label_1.setImmediate(false);
		label_1.setWidth("-1px");
		label_1.setHeight("-1px");
		label_1.setValue("(");
		mainLayout.addComponent(label_1);
		
		// lonTextField
		lonTextField = new TextField();
		lonTextField.setImmediate(false);
		lonTextField.setWidth("100px");
		lonTextField.setHeight("-1px");
		lonTextField.setInputPrompt("Longitud");
		mainLayout.addComponent(lonTextField);
		
		// label_2
		label_2 = new Label();
		label_2.setImmediate(false);
		label_2.setWidth("-1px");
		label_2.setHeight("-1px");
		label_2.setValue(",");
		mainLayout.addComponent(label_2);
		
		// latTextField
		latTextField = new TextField();
		latTextField.setImmediate(false);
		latTextField.setWidth("100px");
		latTextField.setHeight("-1px");
		latTextField.setInputPrompt("Latitud");
		mainLayout.addComponent(latTextField);
		
		// label_3
		label_3 = new Label();
		label_3.setImmediate(false);
		label_3.setWidth("-1px");
		label_3.setHeight("-1px");
		label_3.setValue(")");
		mainLayout.addComponent(label_3);
		
		// horizontalLayout_3
		horizontalLayout_3 = new HorizontalLayout();
		horizontalLayout_3.setImmediate(false);
		horizontalLayout_3.setWidth("-1px");
		horizontalLayout_3.setHeight("-1px");
		horizontalLayout_3.setMargin(false);
		mainLayout.addComponent(horizontalLayout_3);
		mainLayout.setExpandRatio(horizontalLayout_3, 1.0f);
		
		// latLonFetchButton
		latLonFetchButton = new Button();
		latLonFetchButton.setCaption("Buscar");
		latLonFetchButton.setImmediate(true);
		latLonFetchButton.setWidth("-1px");
		latLonFetchButton.setHeight("-1px");
		mainLayout.addComponent(latLonFetchButton);
		mainLayout.setComponentAlignment(latLonFetchButton, new Alignment(33));
		
		return mainLayout;
	}

}
